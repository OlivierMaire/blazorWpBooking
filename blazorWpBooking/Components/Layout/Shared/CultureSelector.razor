@using Microsoft.AspNetCore.Components
@using System.Globalization
@using Microsoft.AspNetCore.Localization
@using Microsoft.AspNetCore.Http
@using Microsoft.JSInterop
@using System.Web
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager
@inject IHttpContextAccessor HttpContextAccessor
@inject IJSRuntime JSRuntime

<div class="d-flex align-items-center">
    <label class="me-2 mb-0">@System.Globalization.CultureInfo.CurrentCulture.Name</label>
    <label class="me-2 mb-0">@Localizer["Language"]:</label>
    <select class="form-select form-select-sm w-auto" @bind="SelectedCulture" @bind:after="OnCultureChanged">
        <option value="en-US">@Localizer["English"]</option>
        <option value="fr-FR">@Localizer["French"]</option>
        <option value="ja-JP">@Localizer["Japanese"]</option>
    </select>
</div>

@code {
    [Inject]
    private IStringLocalizer<blazorWpBooking.Resources.SharedResource> Localizer { get; set; } = default!;

    private string SelectedCulture { get; set; } = "en-US";

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to navigation changes
        NavigationManager.LocationChanged += OnLocationChanged;

        await InitializeCultureAsync();
        StateHasChanged();
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        await InitializeCultureAsync();
        StateHasChanged();
    }

    private async Task InitializeCultureAsync()
    {
        SelectedCulture = System.Globalization.CultureInfo.CurrentCulture.Name;
    }

    private async Task OnCultureChanged()
    {
        // Save the selected culture to localStorage
        await LocalStorage.SetItemAsync("selectedCulture", SelectedCulture);

        // Save also to cookie with JS interop
        var cookieValue = HttpUtility.UrlEncode($"{SelectedCulture}");
        await JSRuntime.InvokeVoidAsync("blazorWpBooking.setCultureCookieAndReload", CookieRequestCultureProvider.DefaultCookieName, 
        CookieRequestCultureProvider.MakeCookieValue(new RequestCulture(SelectedCulture)));


        // Navigate to the current page with the culture parameter
        // This will trigger the culture middleware to set the cookie
        var currentUri = new Uri(NavigationManager.Uri);
        var baseUri = currentUri.GetLeftPart(UriPartial.Path);
        var query = $"culture={Uri.EscapeDataString(SelectedCulture)}";


        // Check if there are existing query parameters
        var existingQuery = currentUri.Query.TrimStart('?');
        if (!string.IsNullOrEmpty(existingQuery))
        {
            // Remove existing culture parameter if present
            var queryParams = existingQuery.Split('&')
            .Where(p => !p.StartsWith("culture="))
            .ToArray();

            if (queryParams.Length > 0)
            {
                query = $"{string.Join("&", queryParams)}&{query}";
            }
        }

        var newUri = $"{baseUri}?{query}";
        NavigationManager.NavigateTo(newUri, forceLoad: true);
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}