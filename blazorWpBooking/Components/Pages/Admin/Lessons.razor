@page "/admin/lessons"
@using Microsoft.EntityFrameworkCore
@using blazorWpBooking.Data
@inject blazorWpBooking.Services.LessonService LessonService
@inject blazorWpBooking.Services.LessonTypeService LessonTypeService
@inject blazorWpBooking.Services.ScheduleService ScheduleService
@inject IJSRuntime Js

@rendermode InteractiveServer

@using blazorWpBooking.Components.Pages.Admin.Shared

<h3>Lessons</h3>

<div>
    <button class="btn btn-primary" @onclick="() => _lessonEditor?.ShowCreateAsync()">Add Lesson</button>
</div>

<LessonEditor @ref="_lessonEditor" OnSaved="OnLessonSaved" />

<table class="table table-striped mt-3">
    <thead>
        <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Schedule</th>
            <th>Published</th>
            <th>Created</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var lesson in _lessons)
        {
            <tr>
                <td>@lesson.Name</td>
                <td>@lesson.Type?.Name</td>
                <td>@lesson.Schedule?.Description</td>
                <td>@(lesson.IsPublished ? "Yes" : "No")</td>
                <td>@lesson.CreatedAt.ToString("g")</td>
                <td>
                    <button class="btn btn-sm btn-primary me-1" @onclick="() => Edit(lesson.Id)">Edit</button>
                    <button class="btn btn-sm btn-danger" @onclick="() => Delete(lesson.Id)">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    private List<blazorWpBooking.Data.Lesson> _lessons = new();
    private List<blazorWpBooking.Data.LessonType> _types = new();
    private List<blazorWpBooking.Data.Schedule> _schedules = new();

    private LessonEditor? _lessonEditor;
    

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _types = await LessonTypeService.GetTypesAsync();
        _schedules = await ScheduleService.GetSchedulesAsync();
        _lessons = await LessonService.GetAllLessonsAsync();
    }

    private Task Edit(int id)
    {
        return Task.Run(async () =>
        {
            var item = await LessonService.GetLessonAsync(id);
            if (item != null && _lessonEditor != null)
            {
                await _lessonEditor.ShowEditAsync(item);
            }
        });
    }

    private async Task Delete(int id)
    {
        var ok = await Js.InvokeAsync<bool>("confirm", $"Delete lesson #{id}? Are you sure?");
        if (!ok) return;
        await LessonService.DeleteAsync(id);
        await LoadData();
    }

    private async Task OnLessonSaved(blazorWpBooking.Data.Lesson l)
    {
        await LoadData();
    }
}
